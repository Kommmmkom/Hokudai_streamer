# DBD Toy Simulation 演習課題（パラメータ探索と物理解釈）

この演習では、DBD（誘電体バリア放電）の**最小モデル**を使い、**リサージュ図形（Q–V）**と**平均電力**の関係をパラメータ掃引で検証します。  
目的は「**どのパラメータが電力を支配するのか**」を定量的に確かめ、その**物理的意味**を説明できるようになることです。

---

## 学習目標
- Q–V ループ面積 × 周波数 ≈ 平均電力という関係を**数値で再確認**する
- `q_event, E_br, d_g, d_b, ε_r, r, V0, f` などの**設計パラメータの感度**を理解する
- **最大電力**となる条件を探索し、**なぜ最大化されるか**を回路・場の観点から説明する
- 掃引・可視化・再現実験の**数値実験プロトコル**を身につける

---

## 事前準備
- `dbd_toy_simulation.py` をリポジトリ直下に配置
- Python 3.9+、`numpy`, `matplotlib`（任意で `pandas`）

> **関数**：`simulate_and_plot(...)`  
> 返り値 `out` に `P_avg, W_cycle, events, C_d, C_g, ...` が含まれます。`make_plots=False` で計算のみ可能。

---

## 課題 1：ベースラインの検証（純容量と放電導入）
1. **純容量**（`q_event=0`）で 3–6 周期を計算し、Q–V が直線で**面積≈0**、**P≈0**であることを確認。  
2. `q_event` を 5–20 pC に増やして再計算。**段差（階段状）の Q–V** と**非ゼロの面積**を観察。  
3. **考察**：面積が生じる**必要条件**は何か？（ヒント：充放電の履歴＝表面電荷の“記憶”）

---

## 課題 2：単一パラメータ掃引と感度
以下の各パラメータについてベースラインから**1 つずつ**変えて `P_avg` と `events`（放電回数）をプロット。
- `q_event`（1–50 pC）
- `E_br`（2–5 MV/m）**または** `d_g`（0.3–2.0 mm）
- `V0`（2–10 kV）
- `f`（1–50 kHz）
- `d_b`（0.2–1.0 mm）と `ε_r`（4–10）
- `r`（0.1–0.5 mm）

**アウトプット**：各パラメータの **P–パラメータ**グラフと簡潔な解釈（2–3 行/図）  
**着眼点**：
- `q_event` ↑ → 1 回あたりの **ΔQ** が増え**ループ肥大**（ただし極端に大きいと数値的制約に注意）  
- `E_br` ↑（または `d_g` ↑）→ 破壊しにくく**events↓** → 面積減  
- `V0` ↑ → ループの**幅（V軸）**拡大、しきい越え頻度↑  
- `f` ↑ → 面積一定でも **P ∝ f**（W_cycle が同程度なら P が線形増）  
- `C_d`（= ε0 ε_r A / d_b）↑ → Q–V の**傾き**変化（容量性直線部の角度）

---

## 課題 3：二次元掃引（設計トレードオフの可視化）
以下から 1 つ選び、**2D 掃引**ヒートマップ（または等高線）で **P_avg** を可視化：
- `(V0, q_event)`、`(E_br, q_event)`、`(d_b, ε_r)`、`(r, d_g)` など

**アウトプット**：
- 2D 図（カラーマップ or 等高線）
- **最適付近のパラメータ組**と**局所感度**（どちらの軸が効いているか）

**考察のヒント**：
- 面積は概ね **「イベントの回数 × 1 回あたりの ΔQ × 有効電圧スケール」** で近似できる
- `E_br` を下げる/`d_g` を薄くするとイベント増だが、実装上の制約や耐圧とのトレードオフ

---

## 課題 4：制約付き**最大電力探索**（コースグリッド→ローカル微調整）
**制約（例）**：
- `V0 ≤ 8 kV`、`1 kHz ≤ f ≤ 30 kHz`
- `0.5 mm ≤ d_g ≤ 2.0 mm`、`0.2 mm ≤ d_b ≤ 1.0 mm`
- `4 ≤ ε_r ≤ 10`、`1 pC ≤ q_event ≤ 50 pC`、`r ≤ 0.5 mm`
- `E_br = 3.0 MV/m` 固定（または実験条件に合わせて）

**手順**：
1. コースグリッドで全域を探索 → 上位 5–10 点を抽出  
2. その近傍で微調整（1D/2D 局所掃引）  
3. **最終的な最良解**と**準最良解**の比較（なぜ差が出る？）

**アウトプット**：
- 上位 5 点の表（パラメータ，`P_avg`, `events`, `W_cycle`）  
- **物理的説明**：  
  - ループ面積はなぜ最大化されたか？  
  - **イベント回数**と**ΔQ**と**有効電圧**の積のどれが支配的？  
  - `C_d/C_g` の比が傾き（履歴の蓄積）に与える影響

---

## 課題 5：**エネルギー分解**と近似式の検証
最後の 1 周期について  

$W_{\text{cycle}} \approx \sum_k \tfrac{1}{2}(V_{a,k}+V_{a,k+1})(Q_{k+1}-Q_k)$

に加え、イベント時の寄与を  

$W_{\text{cycle}} \approx \sum_{\text{events}} V_{a}(t_k)\,\Delta Q_k + \text{（平滑部分）}$

と近似。**イベント和**の寄与率を見積もり、**P ≈ f·Σ(V_aΔQ)** がどの程度成立するか検証。

---

## 発展課題（任意）
- **クランプ型**放電：イベント時に `V_g → V_hold`（保持電圧）とする改変を実装・比較
- **表面リーク**（`R_d` を `C_d` に並列）：周波数依存のパワー特性を再評価
- **確率化**：`q_event` を分布化、`E_br` に揺らぎ → 期待値と分散を評価
- **多セル**：面内で複数セルを独立に合算（総 `Q`）して空間平均の意味を議論

---
<!-- 
## レポート提出物（推奨テンプレート）
1. **目的**（100–200 字）  
2. **方法**（掃引レンジ、分割数、固定条件、`dt_per_period`）  
3. **結果**（図表：単変数・二変数、上位解表、代表 Q–V 図）  
4. **考察**（最大化の要因、感度、トレードオフ、近似の妥当性）  
5. **結論と今後**（設計指針／モデル拡張の提案）
-->
---
<!-- 
## 評価基準（例）
- **再現性のある実験設計**（レンジ設定・刻み・乱数管理）… 25%
- **可視化と読解性**（図表の適切さ・説明の簡潔さ）… 25%
- **物理解釈の深さ**（容量比・イベント機構・電圧スケールの言及）… 30%
- **最適化戦略と妥当性**（コース→微調整、制約順守）… 20%
-->
---

## 最小コード片（掃引テンプレート）

> **注意**：グラフは 1 図 1 系列で十分です。`dt_per_period` は**十分大きく**して面積誤差を抑えてください。

```python
from dbd_toy_simulation import simulate_and_plot
import numpy as np

def sweep(param_name, values, base_kwargs):
    results = []
    for v in values:
        kwargs = dict(base_kwargs)
        kwargs[param_name] = v
        out = simulate_and_plot(make_plots=False, **kwargs)
        results.append((v, out["P_avg"], out["events"], out["W_cycle"]))
    return np.array(results, dtype=float)

# ベース条件
base = dict(V0=6000.0, f=10000.0, cycles=6, E_br=3.0e6,
            r=2.5e-4, d_b=5.0e-4, eps_r=5.0, d_g=1.0e-3,
            q_event=1.0e-11, dt_per_period=4000)

# 例：q_event 掃引
qs = np.linspace(1e-12, 5e-11, 15)
res = sweep("q_event", qs, base)

# res[:,0]=q_event, res[:,1]=P_avg, res[:,2]=events, res[:,3]=W_cycle
import matplotlib.pyplot as plt
plt.figure(figsize=(6,4))
plt.plot(res[:,0]*1e12, res[:,1])
plt.xlabel("q_event [pC]")
plt.ylabel("P_avg [W]")
plt.title("Power vs q_event")
plt.grid(True)
plt.show()
